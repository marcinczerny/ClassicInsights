---
import Layout from "@/layouts/Layout.astro";
import { UpdatePasswordForm } from "@/components/auth/UpdatePasswordForm";
import { createSupabaseServerInstance } from "@/db/supabase.client";

const code = Astro.url.searchParams.get("code");

if (code) {
  const supabase = createSupabaseServerInstance({
    cookies: Astro.cookies,
    headers: Astro.request.headers,
    runtime: Astro.locals.runtime,
  });
  const { error } = await supabase.auth.exchangeCodeForSession(code);

  if (error) {
    console.error("Error exchanging code for session:", error.message);
    return Astro.redirect("/login?message=Failed to verify password reset token.");
  }

  // Redirect to remove the code from the URL and load the page with the session.
  return Astro.redirect("/update-password");
}
---

<Layout title="Update Password | ClassicInsights">
  <div class="flex items-center justify-center min-h-screen">
    <UpdatePasswordForm client:load />
  </div>
</Layout>
